name: 'Module: GitHub Release'

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      flavor:
        required: true
        type: string
      ami_id:
        required: true
        type: string
      prerelease:
        default: false
        type: boolean
      template_artifact:
        required: true
        type: string
      packer_artifact:
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Prepare Assets Directory
        run: mkdir -p ./release-assets

      - name: Download Template
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.template_artifact }}
          path: ./release-assets

      - name: Download Packer Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.packer_artifact }}
          path: ./release-assets

      - name: Extract OS Details
        id: extract-os
        shell: bash
        run: |
          # Define path to config based on version input
          FILE="packer/v1/release-config/${{ inputs.version }}.pkrvars.hcl"
          
          if [[ -f "$FILE" ]]; then
            # Extract text inside quotes for BASE_AMI_NAME
            RAW_OS=$(grep "BASE_AMI_NAME" "$FILE" | cut -d'"' -f2)
            # Clean up wildcards (e.g., ubuntu-server-*)
            CLEAN_OS=$(echo "$RAW_OS" | awk -F/ '{print $NF}' | sed 's/-\*$//')
            echo "os_name=$CLEAN_OS" >> $GITHUB_OUTPUT
          else
            echo "::warning::Config file $FILE not found. Falling back to flavor mapping."
            
            # Fallback logic based on flavor string
            if [[ "${{ inputs.flavor }}" == *"windows"* ]]; then
              echo "os_name=Windows Server" >> $GITHUB_OUTPUT
            else
              echo "os_name=Linux (Ubuntu)" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Generate Release Body
        id: release_body
        run: |
          DATE=$(date +'%Y-%m-%d')
          REPO_URL="https://github.com/${{ github.repository }}"
          
          cat <<EOF > release_body.md
          **MATLAB Version:** ${{ inputs.version }}
          **Operating System:** ${{ steps.extract-os.outputs.os_name }}
          **Image ID:** ${{ inputs.ami_id }}
          **Release Date:** $DATE
          
          [View Full Change History]($REPO_URL/commits/${{ inputs.version }})
          
          ### üõ°Ô∏è Supply Chain Security
          Build provenance attestations for these assets can be verified in the [GitHub Attestations tab]($REPO_URL/attestations).
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.version }}
          name: MATLAB Release ${{ inputs.version }}
          body_path: release_body.md
          files: ./release-assets/*
          draft: false
          prerelease: ${{ inputs.prerelease }}