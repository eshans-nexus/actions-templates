name: 'Module: AWS Smoke Test'

on:
  workflow_call:
    inputs:
      template_artifact:
        required: true
        type: string
      flavor:
        required: true
        type: string
      ami_id:
        required: false
        type: string
      region:
        default: 'us-east-1'
        type: string
      test_mode:
        default: false
        type: boolean
    secrets:
      AWS_OIDC_ROLE:
        required: true
      TEST_VPC_ID:
        required: true
      TEST_SUBNET_ID:
        required: true

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ inputs.region }}

      - name: Create Ephemeral Key
        if: inputs.test_mode == false
        id: ssh-key
        run: |
          KEY_NAME="smoke-${{ github.run_id }}-${{ github.run_number }}"
          aws ec2 create-key-pair --key-name $KEY_NAME --query 'KeyMaterial' --output text > private_key.pem
          chmod 600 private_key.pem
          echo "NAME=$KEY_NAME" >> $GITHUB_OUTPUT

      - name: Deploy Infrastructure
        if: inputs.test_mode == false
        id: deploy
        uses: eshans-nexus/actions-templates/.github/actions/deploy-cfn@main
        with:
          stack_name: "smoke-test-${{ github.run_id }}"
          template_artifact: ${{ inputs.template_artifact }} 
          flavor: ${{ inputs.flavor }}
          region: ${{ inputs.region }}
          vpc_id: ${{ secrets.TEST_VPC_ID }}
          subnet_id: ${{ secrets.TEST_SUBNET_ID }}
          key_name: ${{ steps.ssh-key.outputs.NAME }}
          ami_id: ${{ inputs.ami_id }}

      # --- VERIFICATION LOGIC ---
      - name: Verify Deployment (Linux)
        if: inputs.test_mode == false && contains(inputs.flavor, 'linux')
        env:
          OUTPUTS: ${{ steps.deploy.outputs.stack_outputs }}
        run: |
          # Parse the relevant host connection string from the JSON output
          # Try generic output names or specific ones
          HOST=$(echo $OUTPUTS | jq -r '.HeadnodePublicDNS // .RDPConnection // .ServerAddress')
          
          # Clean HTTPS if present (NLM)
          HOST=$(echo $HOST | sed 's/https:\/\///')
          
          echo "Connecting to $HOST..."
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts || true
          
          # Simple check command
          ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@$HOST "uptime"

      - name: Verify Deployment (Windows)
        if: inputs.test_mode == false && contains(inputs.flavor, 'windows')
        env:
          OUTPUTS: ${{ steps.deploy.outputs.stack_outputs }}
        run: |
          HOST=$(echo $OUTPUTS | jq -r '.HeadnodePublicDNS // .RDPSSHConnection')
          echo "Checking RDP Port on $HOST..."
          timeout 300 bash -c "until nc -z -v -w5 $HOST 3389; do sleep 15; done"

      # --- CLEANUP ---
      - name: Cleanup
        if: always() && inputs.test_mode == false
        run: |
          aws cloudformation delete-stack --stack-name "smoke-test-${{ github.run_id }}"
          aws ec2 delete-key-pair --key-name ${{ steps.ssh-key.outputs.NAME }}