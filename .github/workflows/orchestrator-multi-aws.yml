name: 'Orchestrator: Multi-version AWS Build Pipeline'

on:
  workflow_call:
    inputs:
      matlab_versions:
        description: "Comma-separated list (e.g. R2025a,R2024b). Empty = Latest 5."
        required: false
        type: string
      flavor: 
        description: "Deployment flavor (matlab-linux, ps-linux, etc)"
        required: true
        type: string
      packer_dir:
        default: './packer/v1'
        type: string
      template_dir_pattern:
        default: './releases/{0}'
        type: string
      template_file_name:
        default: 'aws-matlab-template.json'
        type: string
      test_mode:
        default: false
        type: boolean

jobs:
  prepare-versions:
    name: Determine MATLAB versions to build
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Calculate Versions
        id: set-matrix
        shell: python
        env:
          INPUT_VERSIONS: ${{ inputs.matlab_versions }}
          BASE_DIR: ${{ inputs.template_dir_pattern }} 
        run: |
          import os, json, re

          input_str = os.environ.get('INPUT_VERSIONS', '').strip()
          
          if input_str:
              # User provided specific list
              versions = [v.strip() for v in input_str.split(',') if v.strip()]
          else:
              # We need to look at the directory where the template pattern points.
              # Assuming pattern is "./releases/{0}", we look in "./releases"
              target_dir = "./releases" 
              
              if not os.path.exists(target_dir):
                  print(f"Directory {target_dir} not found.")
                  exit(1)

              pattern = re.compile(r'^R20\d{2}[ab]$')
              found = []
              for item in os.listdir(target_dir):
                  if pattern.match(item) and os.path.isdir(os.path.join(target_dir, item)):
                      found.append(item)
              
              # Sort descending and take top 5
              found.sort(reverse=True)
              versions = found[:5]

          print(f"Selected versions: {versions}")
          
          # Write output
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"matrix={json.dumps(versions)}\n")

  create-artifacts:
    name: Run build and test pipeline
    needs: prepare-versions
    name: Process ${{ matrix.version }}
    strategy:
        fail-fast: false
        max-parallel: 5
        matrix:
          version: ${{ fromJson(needs.prepare-versions.outputs.matrix) }}
    uses: eshans-nexus/actions-templates/.github/workflows/orchestrator-single-aws.yml@main
    with:
      matlab_version: ${{ matrix.version }}
      flavor: ${{ inputs.flavor }}
      packer_dir: ${{ inputs.packer_dir }}
      template_dir_pattern: ${{ inputs.template_dir_pattern }}
      template_file_name: ${{ inputs.template_file_name }}
      test_mode: ${{ inputs.test_mode }}
      artifact_suffix: ${{ matrix.version }}
    secrets: inherit

  release-artifacts:
    name: Create Aggregate GH Release
    needs: create-artifacts
    uses: eshans-nexus/actions-templates/.github/workflows/module-gh-aggregate-release.yml@main
    with:
      release_tag: "Build-${{ github.run_number }}-${{ inputs.flavor }}"
      prerelease: false
    secrets: inherit