name: 'Module: Aggregate GitHub Release'

on:
  workflow_call:
    inputs:
      release_tag:
        required: true
        type: string
      prerelease:
        default: true
        type: boolean

jobs:
  publish:
    name: Create GH release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Make staging directories
        run: |
          mkdir -p ./all-artifacts
          mkdir -p ./final-assets

      # Download EVERYTHING (Templates, Logs, Metadata) from all matrix jobs
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-artifacts

      - name: Flatten Assets
        run: |
          # The files are already named uniquely (e.g., R2025a-manifest.json)
          # We just need to pull them out of their artifact folders.
          
          cd ./all_artifacts
          find . -type f -exec cp {} ../release-assets/ \;
          
          echo "Final assets for release:"
          ls -R ../release-assets

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_tag }}
          name: MATLAB Multi-Version Build (${{ inputs.release_tag }})
          body_path: ./final-assets/release_body.md
          files: ./final-assets/*
          draft: false
          prerelease: ${{ inputs.prerelease }}