name: 'Module: GitHub Release'

on:
  workflow_call:
    inputs:
      files_pattern:
        description: "Glob pattern for files to release (e.g., 'releases/**/*.json')"
        required: true
        type: string
      release_tag:
        description: "Unique tag for this release (e.g. R2024b-build-101)"
        required: true
        type: string
      release_title:
        description: "Title of the release"
        required: false
        type: string
      prerelease:
        description: "Mark as pre-release"
        required: false
        type: boolean
      generate_attestations:
        description: "Generate SLSA attestations for these artifacts"
        required: false
        type: boolean

jobs:
  gh-release:
    name: Publish GH Release
    runs-on: ubuntu-latest
    permissions:
      contents: write       # Required to create the release
      id-token: write       # Required for attestation signing
      attestations: write   # Required to store attestations

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Archive and Zip Artifacts
        id: files
        shell: bash
        run: |
          mkdir -p release_assets

          # 1. Flatten artifacts first (move from subfolders to one place)
          # We assume your filenames are unique like "R2024a-something.json"
          find ./artifacts -type f -name "${{ inputs.files_pattern }}" -exec mv {} ./artifacts/ \;

          # 2. Identify unique versions based on your naming convention (R20xx[ab])
          # This regex looks for strings starting with R, followed by 4 digits, ending in a or b
          VERSIONS=$(ls ./artifacts | grep -oE '^R20[0-9]{2}[ab]' | sort | uniq)

          echo "Found versions: $VERSIONS"

          # 3. Loop through versions and create Zips
          for VER in $VERSIONS; do
            echo "Zipping artifacts for $VER..."
            
            # Zip all files starting with that version prefix
            # -j ignores directory paths (junk paths) so the zip is flat
            zip -j "release_assets/${VER}-artifacts.zip" ./artifacts/${VER}*
          done

          echo "Prepared Zips:"
          ls -l release_assets/

      - name: Generate Artifact Attestation
        if: inputs.generate_attestations
        id: attest
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: "release_assets/*.zip"

      - name: Generate Body Text
        id: body
        shell: bash
        env:
          ATTESTATION_URL: ${{ steps.attest.outputs.attestation-url }}
        run: |
          # Create a dynamic body text
          TEXT="## Automated Build Release"
          TEXT="${TEXT}\n\n**Build Tag:** \`${{ inputs.release_tag }}\`"
          TEXT="${TEXT}\n**Date:** $(date)"
          
          if [[ -n "$ATTESTATION_URL" ]]; then
             TEXT="${TEXT}\n\n### üîê Security Attestations"
             TEXT="${TEXT}\nThis release includes SLSA provenance attestations verified by GitHub."
             TEXT="${TEXT}\n- [View Attestation Details]($ATTESTATION_URL)"
          fi
          
          # Handle multiline string for GITHUB_OUTPUT
          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          echo -e "$TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_title || inputs.release_tag }}
          body: ${{ steps.body.outputs.release_body }}
          files: release_assets/*.zip
          prerelease: ${{ inputs.prerelease }}
          fail_on_unmatched_files: true